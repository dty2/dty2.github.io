---
title: IM
sticky: 490
---

制作IM时遇到的问题以及解决方案
<!-- more -->

# IM

## 资源

* [通讯协议设计](http://www.52im.net/thread-283-1-1.html)
* [在线状态的维护方式](http://www.52im.net/thread-715-1-1.html)
* [群消息存储方式](http://www.52im.net/thread-1616-1-1.html)
* [知名NOSQL优劣](http://www.52im.net/thread-2759-1-1.html)
* [ID顺序](http://www.52im.net/forum.php?mod=viewthread&tid=3281)

## 科普(门槛)

* 同步/漫游
  同步：近期历史消息，漫游：全部历史消息
* 读/写扩散
  读：一个会话一份, 写：一个人一份
* 鉴权
  判断是否为好友

## IM特性

* 客户端在进行请求操作后就掉线了，注册，登陆，同步，查询，管理(加/删好友)，发消息等功能会做出什么措施

  1. 客户端在发送完注册请求后断网掉线，客户端和服务端应该怎么办？

  客户端主动与服务端重联，并显示给用户注册失败，保留用户刚才填写的注册内容

  服务端因第一次建连的套接字断所以作废(关闭套接字)，并将刚才生成的用户ID和接收到的用户信息作废，等待新的连接

  涉及底层问题：TCP掉线会不会自动重连？发送TCP包多长时间收不到为掉线？

  2. ，客户端和服务端应该怎么办？

### 鉴权问题
[出处](http://www.52im.net/forum.php?mod=viewthread&tid=3238&highlight=%B4%E6%B4%A2)
问题：
当服务器接收到来自客户端单聊消息时，服务器是否要检查该客户端和其发送该单聊消息的对端是否为好友关系(即是否有权限给对方发送消息)

解决方案：
在客户端、服务端做好安全措施的情况下，好友关系的鉴权其实没想的那么严肃，放到客户端处理就好了
服务端来处理的话，一是会加重逻辑复杂性，二是性能一定会有影响，不划算。
im这种东西，不是金融系统，是可以允许万有一失的，qq也都是这个设计原则。


### 群

#### 问题1
[出处](http://www.52im.net/forum.php?mod=viewthread&tid=4147&highlight=%B4%E6%B4%A2)
问题：
群聊逻辑中首先利用一个线程去处理一条消息的转发，其中会拿到缓存中的群员信息，循环进行推送，如果推送失败则进行存储离线消息。
请问这里的逻辑是否可以提前判断群员在线状态，如果在线则进行推送，不在线则直接下一条，等最后批量给离线用户插入离线消息数据。
或者说用户虽然判断离线，实际可能在线？请问会出现这种情况吗

解决方案：
是的，如果在线人数多，且发送是有耗时的，等在线全发完后，在这个时间差之内，可能此时的‘离线“状态就已经不准确了，极端情况下，用户上线时就没有拉到刚才的”离线“消息，会影响体验。
其实，群聊的这段代码是有优化空间的，比如你可以在现有的逻辑上，为了不让离线消息因数据库的慢IO拖累性能，可以把它扔到mq或redis里，再由mq或redis的消费者再去往数据库里落库，这样就既不影响实时消息的吞吐效率，又能保证在线状态的准确性

### 传输

* 传什么

* 怎么传

* 用什么传

### 存储

* 存什么

对于不支持漫游的IM来说，消息只需存近期的即可，达到同步效果就行

对于支持漫游的IM，则需存储所有的消息

对于好友关系来说，一定要在服务端存储，不然手机丢了账号就废了，基本(公有)信息，私有信息也是如此

* 怎么存

对于单聊采用写扩散，群聊采用读扩散

(业务压力不大可都采用写扩散，统一方便)

* 存多长时间

支持同步的IM，支持存7天，视频，音频，文件等可存3天

支持漫游的IM，支持永久存储，对于注销账号则可删除

### 逻辑

### 安全
